<!-- P√°gina Moodle: Query Params en REST y Spring Boot -->
<section style="font-family: Arial, sans-serif; line-height: 1.6">
  <h2 style="color: #0055a4; margin-bottom: 0.5em">
    Query Params en APIs REST y Spring Boot
  </h2>
  <p>
    En esta p√°gina veremos c√≥mo usar par√°metros de consulta (<em
      >query params</em
    >) para filtrar, paginar y ordenar recursos en una API REST, y c√≥mo
    implementarlos en Spring Boot con Spring Data JPA.
  </p>

  <!-- 1. Introducci√≥n -->
  <h3 style="color: #004080; margin-top: 1.5em">
    1. Introducci√≥n a los Query Params en REST
  </h3>
  <ul style="margin-left: 1em">
    <li>
      <strong>Qu√© son:</strong> par√°metros anexados a la URL tras el car√°cter
      <code>?</code>, separados por <code>&amp;</code>.
    </li>
    <li>
      <strong>Para qu√© sirven:</strong> filtrar resultados
      (<code>?status=activo</code>), paginar (<code>?page=2&amp;size=10</code>),
      ordenar (<code>?sortBy=fecha&amp;order=desc</code>), etc.
    </li>
  </ul>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>GET /api/v1/usuarios?role=admin&amp;active=true
GET /api/v1/productos?page=1&amp;size=20&amp;sort=precio,asc
</code>
  </pre>

  <!-- 2. Convenciones -->
  <h3 style="color: #004080; margin-top: 1.5em">
    2. Convenciones y Buenas Pr√°cticas
  </h3>
  <ul style="margin-left: 1em">
    <li>
      <code>nombre</code> claro y consistente (<code>?tipo=agua</code> en vez de
      <code>?t=agua</code>).
    </li>
    <li><code>required=false</code> para par√°metros opcionales.</li>
    <li>
      Valores por defecto con <code>defaultValue</code> para evitar
      <em>400 Bad Request</em>.
    </li>
    <li>
      Validaci√≥n de tipos: <code>@Positive</code>, <code>@Min</code>, etc.
    </li>
  </ul>

  <!-- 3. Implementaci√≥n en Spring Boot -->
  <h3 style="color: #004080; margin-top: 1.5em">
    3. Implementaci√≥n de Query Params en Spring Boot
  </h3>
  <p>
    En Spring Boot, los par√°metros de consulta se reciben en el controlador
    usando <code>@RequestParam</code>. As√≠ puedes filtrar, paginar y ordenar
    resultados de forma flexible. Cada par√°metro puede ser opcional (<code
      >required = false</code
    >) o tener un valor por defecto (<code>defaultValue</code>).
  </p>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>@GetMapping("/api/v2/pokemons/buscar")
// Par√°metros de consulta:
// - tipo:       filtra por texto parcial en el campo 'tipo' (no sensible a may√∫sculas)
// - nivelMin:   nivel m√≠nimo (inclusive)
// - nivelMax:   nivel m√°ximo (inclusive)
// - sortBy:     campo por el que ordenar (ej: id, nivel, salud)
// - order:      direcci√≥n de la ordenaci√≥n ("asc" o "desc")
public ResponseEntity&lt;List&lt;Pokemon&gt;&gt; search(
    @RequestParam(name = "tipo",     required = false)      String tipo,
    @RequestParam(name = "nivelMin", required = false)      Integer nivelMin,
    @RequestParam(name = "nivelMax", required = false)      Integer nivelMax,
    @RequestParam(name = "sortBy",   defaultValue = "id")   String sortBy,
    @RequestParam(name = "order",    defaultValue = "asc")  String order
) {
    // 1. Determinar direcci√≥n de ordenaci√≥n
    Sort.Direction dir = order.equalsIgnoreCase("desc")
            ? Sort.Direction.DESC
            : Sort.Direction.ASC;
    // 2. Crear objeto Sort
    Sort sort = Sort.by(dir, sortBy);

    // 3. Llamar al servicio, que aplica valores por defecto si nivelMin/Max son null
    List&lt;Pokemon&gt; resultados = pokemonSvc.searchPokemons(tipo, nivelMin, nivelMax, sort);
    return ResponseEntity.ok(resultados);
}
</code></pre>
  <ul style="margin-left: 1em">
    <li>
      <strong>Par√°metros opcionales:</strong> Si no se env√≠a <code>tipo</code>,
      <code>nivelMin</code> o <code>nivelMax</code>, su valor ser√°
      <code>null</code> y el servicio aplicar√° los valores por defecto.
    </li>
    <li>
      <strong>Ordenaci√≥n flexible:</strong> <code>sortBy</code> y
      <code>order</code> permiten ordenar por cualquier campo y direcci√≥n.
    </li>
    <li>
      <strong>Validaci√≥n autom√°tica:</strong> Si el tipo no es correcto (por
      ejemplo, <code>nivelMin=abc</code>), Spring devuelve
      <em>400 Bad Request</em>.
    </li>
  </ul>
  <p style="margin-top: 0.5em">
    <strong>¬øC√≥mo funciona <code>@RequestParam</code>?</strong>
  </p>
  <ul style="margin-left: 1em">
    <li>
      <code>name</code>: nombre del par√°metro en la URL. Si difiere del nombre
      Java, usar <code>@RequestParam("paramNombre")</code>.
    </li>
    <li>
      <code>required=true|false</code>: si es <code>false</code>, el par√°metro
      es opcional y su valor ser√° <code>null</code> (o el
      <code>defaultValue</code> si se define).
    </li>
    <li>
      <code>defaultValue="valor"</code>: asigna un valor cuando el par√°metro no
      se env√≠a o llega vac√≠o. Definir <code>defaultValue</code> ignora
      <code>required</code>.
    </li>
    <li>
      <strong>Conversi√≥n autom√°tica:</strong> Spring usa su
      <em>ConversionService</em> para convertir la cadena recibida a tipos Java:
      <code>String</code>, <code>Integer</code>, <code>Long</code>,
      <code>Boolean</code>, <code>Double</code>, <code>BigDecimal</code>,
      <code>Enum</code>, <code>LocalDate</code> (ISO-8601), etc. Si la
      conversi√≥n falla, se devuelve <em>400 Bad Request</em>.
    </li>
    <li>
      <strong>Listas y arrays:</strong> se pueden recibir como
      <code>@RequestParam List&lt;String&gt; tags</code> usando
      <code>?tags=a,b,c</code> o m√∫ltiples par√°metros
      <code>?tags=a&amp;tags=b&amp;tags=c</code>.
    </li>
  </ul>

  <!-- 4. Ordenaci√≥n din√°mica -->
  <h3 style="color: #004080; margin-top: 1.5em">
    4. Construir din√°mica la ordenaci√≥n
  </h3>
  <p>
    Convertimos <code>sortBy</code> y <code>order</code> en un
    <code>Sort</code> de Spring Data, que representa la cl√°usula
    <strong>ORDER BY</strong> de la consulta SQL.
  </p>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>Sort.Direction dir = order.equalsIgnoreCase("desc")
        ? Sort.Direction.DESC
        : Sort.Direction.ASC;
Sort sort = Sort.by(dir, sortBy);
</code>
  </pre>
  <p style="margin-top: 0.5em">
    <strong>¬øQu√© es <code>Sort</code>?</strong><br />
    El objeto <code>Sort</code> encapsula los criterios de ordenaci√≥n (campo y
    direcci√≥n). Spring Data JPA lo traduce a una cl√°usula
    <code>ORDER BY</code> en la consulta SQL, evitando concatenar SQL
    manualmente.
  </p>
  <ul style="margin-left: 1em">
    <li>
      <strong>Dynamicidad:</strong> Permite elegir el campo
      (<code>sortBy</code>) y la direcci√≥n (<code>asc</code>/ <code>desc</code>)
      en tiempo de ejecuci√≥n.
    </li>
    <li>
      <strong>Seguridad:</strong> Al usar <code>Sort.by(...)</code>, evitas
      inyecci√≥n de SQL al no construir cadenas SQL manuales.
    </li>
    <li>
      <strong>Reutilizaci√≥n:</strong> Puedes pasar el mismo <code>Sort</code> a
      cualquier m√©todo de repositorio que acepte un par√°metro <code>Sort</code>.
    </li>
    <li>
      <strong>Mantenimiento:</strong> Centraliza la l√≥gica de ordenaci√≥n sin
      alterar el repositorio ni usar <code>@Query</code> (<em
        >aunque existe, no lo usaremos en este curso</em
      >).
    </li>
    <p style="margin-left: 2em; font-size: 0.9em; color: #555">
      <code>@Query</code> permite definir consultas JPQL o SQL personalizadas
      directamente sobre el m√©todo del repositorio, ofreciendo mayor
      flexibilidad cuando las <em>query methods</em> por nombre no son
      suficientes.
    </p>
  </ul>

  <!-- 5. Query Methods en Spring Data -->
  <h3 style="color: #004080; margin-top: 1.5em">
    5. Derivar consultas por nombre en Spring Data JPA
  </h3>
  <p>En el repositorio, Spring Data genera la consulta a partir del m√©todo:</p>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>// üìå MUY IMPORTANTE: el nombre del m√©todo NO es s√≥lo est√©tico; 
// Spring Data JPA lo parsea para construir la consulta.
List&lt;Pokemon&gt; findByTipoContainingIgnoreCaseAndNivelBetween(
    String tipo,
    int nivelMin,
    int nivelMax,
    Sort sort
);
</code>
  </pre>
  <p style="margin-top: 1em">
    <strong>Detalles de la derivaci√≥n por nombre:</strong>
  </p>
  <ul style="margin-left: 1em">
    <li>
      <strong>Prefijos v√°lidos:</strong> <code>findBy‚Ä¶</code>,
      <code>findAllBy‚Ä¶</code>, <code>readBy‚Ä¶</code>, <code>queryBy‚Ä¶</code>.
      Todos devuelven una colecci√≥n cuando el m√©todo retorna <code>List</code>.
    </li>
    <li>
      <strong>Palabras clave:</strong>
      <code>By</code> marca el inicio de las condiciones, <code>And</code> y
      <code>Or</code> combinan m√∫ltiples filtros.
    </li>
    <li>
      <strong>Operadores soportados:</strong>
      <code>Containing</code> (LIKE '%valor%'),
      <code>IgnoreCase</code> (insensible a may√∫sculas),
      <code>Between</code> (rango), <code>LessThan</code>,
      <code>GreaterThan</code>, <code>IsNull</code>, etc.
    </li>
    <li>
      <strong>Ordenaci√≥n din√°mica:</strong>
      No incluimos <code>OrderBy</code> en el nombre cuando usamos un par√°metro
      <code>Sort</code>. Spring Data aplicar√° el <code>ORDER BY</code> definido
      por el objeto <code>Sort</code>.
    </li>
    <li>
      <strong>C√≥mo se traduce a SQL:</strong>
      <pre
        style="
          background: #f7f7f7;
          padding: 0.6em;
          border: 1px solid #ddd;
          overflow-x: auto;
        "
      >
<code>SELECT * 
FROM pokemon 
WHERE LOWER(tipo) LIKE LOWER(CONCAT('%', :tipo, '%')) 
  AND nivel BETWEEN :nivelMin AND :nivelMax 
ORDER BY :sortProperty :sortDirection;
</code>
      </pre>
      (Spring Data reemplaza <code>:tipo</code>, <code>:nivelMin</code>, etc., y
      ordena seg√∫n el <code>Sort</code>).
    </li>
    <li>
      <strong>Importancia del nombre del m√©todo:</strong>
      El nombre del m√©todo no es solo para legibilidad: Spring Data JPA lo
      parsea para generar la consulta (propiedades y operadores). Debe coincidir
      exactamente con tus atributos de entidad y operadores v√°lidos.
    </li>
    <li>
      <strong>¬øQu√© ocurre si lo nombras mal?</strong>
      Spring Data lanzar√° una <code>PropertyReferenceException</code> al
      arrancar si no encuentra la propiedad (p. ej.
      <code>findByFuerzaContainingIgnoreCaseAndNivelBetween</code> falla porque
      no existe ‚Äúfuerza‚Äù).
    </li>
  </ul>

  <!-- 6. Errores comunes -->
  <h3 style="color: #004080; margin-top: 1.5em">
    6. Errores comunes y c√≥mo evitarlos
  </h3>
  <ul style="margin-left: 1em">
    <li>
      <strong>Fragmentos inv√°lidos en m√©todos de repositorio:</strong><br />
      Usar un nombre como <code>findByFuerza‚Ä¶</code> donde no existe ‚Äúfuerza‚Äù
      causa una <em>PropertyReferenceException</em> al iniciar la aplicaci√≥n.
    </li>
    <li>
      <strong>Uso de <code>OrderBy</code> sin propiedad:</strong><br />
      Definir un m√©todo como <code>findByTipoOrderBy</code> sin especificar el
      campo provoca un fallo de parsing al arrancar.
    </li>
    <li>
      <strong>Tipo de par√°metro incorrecto:</strong><br />
      Enviar <code>?nivelMin=abc</code> produce una
      <em>MethodArgumentTypeMismatchException</em> y un
      <em>400 Bad Request</em>.
    </li>
    <li>
      <strong>Falta de par√°metro obligatorio:</strong><br />
      Si tienes <code>@RequestParam(required=true)</code> y no env√≠as el
      par√°metro, obtendr√°s una
      <em>MissingServletRequestParameterException</em> y un
      <em>400 Bad Request</em>.
    </li>
    <li>
      <strong>Valor de <code>sortBy</code> no v√°lido:</strong><br />
      Un <code>?sortBy=velocidad</code> cuando no existe esa propiedad puede
      lanzar excepciones al ejecutar la consulta o devolver resultados
      inesperados.
    </li>
    <li>
      <strong>Enum o formato de fecha inv√°lido:</strong><br />
      Enviar <code>?order=descending</code> (en lugar de
      <code>asc</code>/<code>desc</code>), o una fecha mal formateada, causa un
      <em>400 Bad Request</em>.
    </li>
    <li>
      <strong>Validaciones con <code>@Positive</code> y similares:</strong
      ><br />
      Par√°metros como <code>?nivelMin=-5</code> ser√°n rechazados con un
      <em>400</em> si est√°n anotados con validaciones de Spring Validation.
    </li>
  </ul>

  <!-- 7. Ejemplos pr√°cticos -->
  <h3 style="color: #004080; margin-top: 1.5em">7. Ejemplos pr√°cticos</h3>
  <ul style="margin-left: 1em">
    <li>
      <code>GET /api/v2/pokemons/buscar</code> ‚Üí lista completa ordenada por
      <code>id</code>.
    </li>
    <li>
      <code>GET /api/v2/pokemons/buscar?tipo=agua</code> ‚Üí filtra por tipo
      ‚Äúagua‚Äù.
    </li>
    <li>
      <code>GET /api/v2/pokemons/buscar?nivelMin=10&amp;nivelMax=50</code> ‚Üí
      rango de nivel.
    </li>
    <li>
      <code>GET /api/v2/pokemons/buscar?sortBy=salud&amp;order=desc</code> ‚Üí
      orden por salud descendente.
    </li>
    <li>
      <code
        >GET
        /api/v2/pokemons/buscar?tipo=fuego&amp;nivelMin=5&amp;nivelMax=30&amp;sortBy=nivel&amp;order=asc</code
      >
      ‚Üí mezcla de filtros y orden.
    </li>
  </ul>

  <!-- 8. C√≥digo paso a paso -->
  <h3 style="color: #004080; margin-top: 1.5em">8. C√≥digo paso a paso</h3>
  <p><strong>1. Repositorio:</strong></p>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>public interface PokemonRepository extends JpaRepository&lt;Pokemon, Long&gt; {
    // ‚Ä¶
    List&lt;Pokemon&gt; findByTipoContainingIgnoreCaseAndNivelBetween(
        String tipo, int nivelMin, int nivelMax, Sort sort
    );
}
</code>
  </pre>
  <p><strong>2. Servicio:</strong></p>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>@Service
public class PokemonService {
    // ‚Ä¶
    public List&lt;Pokemon&gt; searchPokemons(
        String tipo, Integer nivelMin, Integer nivelMax, Sort sort
    ) {
        String t = (tipo == null ? \"\" : tipo);
        int min = (nivelMin == null ? 0 : nivelMin);
        int max = (nivelMax == null ? Integer.MAX_VALUE : nivelMax);
        return pokemonRepo.findByTipoContainingIgnoreCaseAndNivelBetween(
            t, min, max, sort
        );
    }
}
</code>
  </pre>
  <p><strong>3. Controlador:</strong></p>
  <pre
    style="
      background: #f7f7f7;
      padding: 0.8em;
      border: 1px solid #ddd;
      overflow-x: auto;
    "
  ><code>@RestController
@RequestMapping({\"/api/v1/pokemons\", \"/api/v2/pokemons\"})
public class PokemonController {
    // ‚Ä¶
    @GetMapping(\"/buscar\")
    public ResponseEntity&lt;List&lt;Pokemon&gt;&gt; search(
        @RequestParam(required = false) String tipo,
        @RequestParam(required = false) Integer nivelMin,
        @RequestParam(required = false) Integer nivelMax,
        @RequestParam(defaultValue = \"id\") String sortBy,
        @RequestParam(defaultValue = \"asc\") String order
    ) { ‚Ä¶ }
}
</code>
  </pre>

  <!-- 9. Recursos adicionales -->
  <h3 style="color: #004080; margin-top: 1.5em">9. Recursos Adicionales</h3>
  <ul style="margin-left: 1em">
    <li>
      üìò
      <a
        href="https://docs.spring.io/spring-data/jpa/reference/jpa/query-methods.html"
        target="_blank"
        >Spring Data JPA ‚Äì Query Methods</a
      >
    </li>
    <li>
      üìò
      <a
        href="https://docs.spring.io/spring-data/jpa/reference/repositories/query-methods-details.html"
        target="_blank"
      >
        Spring Data JPA ‚Äì Query Methods (detalles)
      </a>
    </li>
    <li>
      üìò
      <a href="https://www.baeldung.com/jpa-query-parameters" target="_blank">
        Baeldung: JPA Query Parameters
      </a>
    </li>
    <li>
      üìò
      <a href="https://www.baeldung.com/spring-request-param" target="_blank"
        >Baeldung: @RequestParam en Spring Boot</a
      >
    </li>
    <li>
      üìò
      <a
        href="https://www.baeldung.com/spring-data-derived-queries"
        target="_blank"
        >Baeldung: Deriving Queries in Spring Data</a
      >
    </li>
    <li>
      üìò
      <a
        href="https://www.baeldung.com/spring-requestparam-vs-pathvariable"
        target="_blank"
      >
        Baeldung: @RequestParam vs @PathVariable
      </a>
    </li>
    <li>
      üìò
      <a href="https://www.baeldung.com/spring-data-jpa-query" target="_blank">
        Baeldung: Spring Data JPA ‚Äì @Query
      </a>
    </li>
  </ul>
</section>
